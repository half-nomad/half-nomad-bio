name: ğŸš€ ë…¸ì…˜ ë¸”ë¡œê·¸ ë™ê¸°í™” (ìˆ˜ì •ë²„ì „)

# íŠ¸ë¦¬ê±° ì¡°ê±´ - ë””ë²„ê¹…ì„ ìœ„í•´ ìˆ˜ë™ ì‹¤í–‰ë§Œ ì¼ì‹œì ìœ¼ë¡œ í™œì„±í™”
on:
  # ìˆ˜ë™ ì‹¤í–‰ (GitHub Actions íƒ­ì—ì„œ)
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™”'
        required: false
        default: 'true'
        type: boolean
  
  # ìŠ¤ì¼€ì¤„ë§ì€ í…ŒìŠ¤íŠ¸ í›„ í™œì„±í™”
  # schedule:
  #   - cron: '0 */2 * * *'  # 2ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰

# í™˜ê²½ ë³€ìˆ˜
env:
  NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
  NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}

jobs:
  sync-notion-blog:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ë¦¬í¬ì§€í† ë¦¬ì— íŒŒì¼ ì“°ê¸° ê¶Œí•œ
    
    steps:
      # 1. í™˜ê²½ ë³€ìˆ˜ ë””ë²„ê¹…
      - name: ğŸ” í™˜ê²½ ë³€ìˆ˜ ì²´í¬
        run: |
          echo "=== í™˜ê²½ ë³€ìˆ˜ ì²´í¬ ==="
          if [ -z "$NOTION_TOKEN" ]; then
            echo "âŒ NOTION_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          else
            echo "âœ… NOTION_TOKEN ì„¤ì •ë¨ (ê¸¸ì´: ${#NOTION_TOKEN})"
          fi
          
          if [ -z "$NOTION_DATABASE_ID" ]; then
            echo "âŒ NOTION_DATABASE_IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          else
            echo "âœ… NOTION_DATABASE_ID ì„¤ì •ë¨: $NOTION_DATABASE_ID"
          fi
      
      # 2. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
      
      # 3. Node.js ì„¤ì •
      - name: ğŸŸ¢ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # cache ì œê±° - package-lock.jsonì´ ì—†ìœ¼ë¯€ë¡œ
      
      # 4. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          echo "=== ì˜ì¡´ì„± ì„¤ì¹˜ ==="
          npm install
          
          echo "=== ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ í™•ì¸ ==="
          npm list
      
      # 5. ë™ê¸°í™” ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
      - name: ğŸ“ ë™ê¸°í™” ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
        run: |
          cat > sync-notion.mjs << 'EOF'
          import { Client } from '@notionhq/client';
          import { writeFileSync } from 'fs';

          async function syncNotionBlog() {
            try {
              console.log('ğŸš€ ë…¸ì…˜ ë¸”ë¡œê·¸ ë™ê¸°í™” ì‹œì‘...');
              
              // í™˜ê²½ ë³€ìˆ˜ ê²€ì¦
              const token = process.env.NOTION_TOKEN;
              const databaseId = process.env.NOTION_DATABASE_ID;
              
              if (!token) {
                throw new Error('NOTION_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
              }
              
              if (!databaseId) {
                throw new Error('NOTION_DATABASE_IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
              }
              
              console.log(`ğŸ“‹ ë°ì´í„°ë² ì´ìŠ¤ ID: ${databaseId}`);
              
              // ë…¸ì…˜ í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
              const notion = new Client({ auth: token });
              
              console.log('ğŸ” ë…¸ì…˜ ì—°ê²° í…ŒìŠ¤íŠ¸...');
              
              // ë°ì´í„°ë² ì´ìŠ¤ ì •ë³´ ë¨¼ì € ê°€ì ¸ì˜¤ê¸° (ì—°ê²° í…ŒìŠ¤íŠ¸)
              const database = await notion.databases.retrieve({
                database_id: databaseId
              });
              
              console.log(`âœ… ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„±ê³µ: ${database.title[0]?.plain_text || 'Untitled'}`);
              
              // ë°œí–‰ëœ í¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
              console.log('ğŸ“š í¬ìŠ¤íŠ¸ ì¡°íšŒ ì¤‘...');
              const response = await notion.databases.query({
                database_id: databaseId,
                filter: {
                  property: 'Status',
                  select: { equals: 'Published' }
                },
                sorts: [{
                  property: 'Published Date',
                  direction: 'descending'
                }],
                page_size: 10  // í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ 10ê°œë§Œ
              });
              
              console.log(`ğŸ“Š ${response.results.length}ê°œì˜ ë°œí–‰ëœ í¬ìŠ¤íŠ¸ ë°œê²¬`);
              
              if (response.results.length === 0) {
                console.log('âš ï¸ ë°œí–‰ëœ í¬ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. Statusê°€ "Published"ì¸ í˜ì´ì§€ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
              }
              
              // í¬ìŠ¤íŠ¸ ë°ì´í„° ë³€í™˜
              const posts = [];
              for (let i = 0; i < response.results.length; i++) {
                const page = response.results[i];
                console.log(`ğŸ“„ í¬ìŠ¤íŠ¸ ${i + 1}/${response.results.length} ì²˜ë¦¬ ì¤‘...`);
                
                try {
                  const postData = await transformNotionPage(notion, page);
                  posts.push(postData);
                  console.log(`âœ… "${postData.title}" ë³€í™˜ ì™„ë£Œ`);
                } catch (error) {
                  console.error(`âŒ í¬ìŠ¤íŠ¸ ë³€í™˜ ì‹¤íŒ¨ (${page.id}):`, error.message);
                }
              }
              
              // blog-data.json ìƒì„±
              const blogData = {
                posts: posts,
                lastUpdated: new Date().toISOString(),
                version: "1.0.0",
                source: "github-actions",
                syncInfo: {
                  totalProcessed: response.results.length,
                  successfullyConverted: posts.length,
                  databaseId: databaseId
                }
              };
              
              // íŒŒì¼ ì €ì¥
              writeFileSync('blog-data.json', JSON.stringify(blogData, null, 2));
              
              console.log(`âœ… blog-data.json ì—…ë°ì´íŠ¸ ì™„ë£Œ!`);
              console.log(`ğŸ“Š ì´ ${posts.length}ê°œ í¬ìŠ¤íŠ¸ ë™ê¸°í™”ë¨`);
              
            } catch (error) {
              console.error('âŒ ë™ê¸°í™” ì˜¤ë¥˜:', error);
              console.error('ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤:', error.stack);
              process.exit(1);
            }
          }

          async function transformNotionPage(notion, page) {
            const properties = page.properties;
            
            // ê¸°ë³¸ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
            const title = properties.Title?.title?.[0]?.plain_text || 'Untitled';
            const excerpt = properties.Excerpt?.rich_text?.[0]?.plain_text || '';
            const categoryData = properties.Category?.select;
            const category = categoryData?.name?.toLowerCase().replace(/\s+/g, '-') || 'general';
            const categoryName = categoryData?.name || 'General';
            const publishedDate = properties['Published Date']?.date?.start || new Date().toISOString().split('T')[0];
            const readTime = `${properties['Read Time']?.number || 5}ë¶„`;
            const thumbnail = properties.Thumbnail?.rich_text?.[0]?.plain_text || 'ğŸ“';

            console.log(`  ì œëª©: ${title}`);
            console.log(`  ì¹´í…Œê³ ë¦¬: ${categoryName}`);
            console.log(`  ë°œí–‰ì¼: ${publishedDate}`);

            // í˜ì´ì§€ ì½˜í…ì¸  ê°€ì ¸ì˜¤ê¸°
            let content = '';
            try {
              const blocks = await notion.blocks.children.list({
                block_id: page.id,
                page_size: 50  // ì½˜í…ì¸ ê°€ ë§ìœ¼ë©´ í˜ì´ì§€ë„¤ì´ì…˜ í•„ìš”
              });
              
              content = transformBlocksToHTML(blocks.results);
              console.log(`  ì½˜í…ì¸  ë¸”ë¡ ìˆ˜: ${blocks.results.length}`);
            } catch (error) {
              console.warn(`âš ï¸ í˜ì´ì§€ ${page.id} ì½˜í…ì¸  ë¡œë“œ ì‹¤íŒ¨:`, error.message);
              content = '<p>ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }

            return {
              id: page.id.replace(/-/g, ''),
              notionId: page.id,
              title: title,
              excerpt: excerpt,
              category: category,
              categoryName: categoryName,
              date: publishedDate,
              readTime: readTime,
              thumbnail: thumbnail,
              content: content
            };
          }

          function transformBlocksToHTML(blocks) {
            let html = '';
            
            for (const block of blocks) {
              html += transformBlockToHTML(block);
            }
            
            return html.trim();
          }

          function transformBlockToHTML(block) {
            const type = block.type;
            
            switch (type) {
              case 'paragraph':
                const text = extractRichText(block.paragraph.rich_text);
                return text ? `<p>${text}</p>\n` : '';
                
              case 'heading_1':
                const h1Text = extractRichText(block.heading_1.rich_text);
                return `<h2>${h1Text}</h2>\n`;
                
              case 'heading_2':
                const h2Text = extractRichText(block.heading_2.rich_text);
                return `<h3>${h2Text}</h3>\n`;
                
              case 'heading_3':
                const h3Text = extractRichText(block.heading_3.rich_text);
                return `<h4>${h3Text}</h4>\n`;
                
              case 'bulleted_list_item':
                const liText = extractRichText(block.bulleted_list_item.rich_text);
                return `<li>${liText}</li>\n`;
                
              case 'numbered_list_item':
                const numText = extractRichText(block.numbered_list_item.rich_text);
                return `<li>${numText}</li>\n`;
                
              case 'quote':
                const quoteText = extractRichText(block.quote.rich_text);
                return `<blockquote>${quoteText}</blockquote>\n`;
                
              case 'code':
                const codeText = extractRichText(block.code.rich_text);
                const language = block.code.language || '';
                return `<pre><code class="${language}">${escapeHtml(codeText)}</code></pre>\n`;
                
              case 'divider':
                return '<hr>\n';
                
              default:
                console.log(`âš ï¸ ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¸”ë¡ íƒ€ì…: ${type}`);
                return '';
            }
          }

          function extractRichText(richTextArray) {
            if (!richTextArray || !Array.isArray(richTextArray)) return '';
            
            return richTextArray.map(textObj => {
              let text = textObj.plain_text || '';
              
              // HTML ì´ìŠ¤ì¼€ì´í”„
              text = escapeHtml(text);
              
              // í¬ë§·íŒ… ì ìš©
              if (textObj.annotations) {
                const { bold, italic, strikethrough, underline, code } = textObj.annotations;
                
                if (code) text = `<code>${text}</code>`;
                if (bold) text = `<strong>${text}</strong>`;
                if (italic) text = `<em>${text}</em>`;
                if (strikethrough) text = `<del>${text}</del>`;
                if (underline) text = `<u>${text}</u>`;
              }
              
              // ë§í¬ ì²˜ë¦¬
              if (textObj.href) {
                text = `<a href="${textObj.href}" target="_blank" rel="noopener">${text}</a>`;
              }
              
              return text;
            }).join('');
          }

          function escapeHtml(text) {
            const map = {
              '&': '&amp;',
              '<': '&lt;',
              '>': '&gt;',
              '"': '&quot;',
              "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
          }

          // ì‹¤í–‰
          syncNotionBlog();
          EOF
      
      # 6. ë…¸ì…˜ ë™ê¸°í™” ì‹¤í–‰
      - name: ğŸ”„ ë…¸ì…˜ ë¸”ë¡œê·¸ ë™ê¸°í™” ì‹¤í–‰
        run: |
          echo "=== ë™ê¸°í™” ì‹œì‘ ==="
          node sync-notion.mjs
          
          echo "=== ìƒì„±ëœ íŒŒì¼ í™•ì¸ ==="
          if [ -f "blog-data.json" ]; then
            echo "âœ… blog-data.json íŒŒì¼ ìƒì„±ë¨"
            echo "ğŸ“Š íŒŒì¼ í¬ê¸°: $(wc -c < blog-data.json) bytes"
            echo "ğŸ” ì²« 10ì¤„ ë¯¸ë¦¬ë³´ê¸°:"
            head -10 blog-data.json
          else
            echo "âŒ blog-data.json íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 1
          fi
      
      # 7. ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
      - name: ğŸ“¤ ë³€ê²½ì‚¬í•­ ì»¤ë°‹
        run: |
          # Git ì‚¬ìš©ì ì„¤ì •
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # ë³€ê²½ì‚¬í•­ í™•ì¸
          echo "=== Git ìƒíƒœ í™•ì¸ ==="
          git status
          
          if [ -n "$(git status --porcelain)" ]; then
            echo "âœ… ë³€ê²½ì‚¬í•­ ë°œê²¬ - ì»¤ë°‹ ì§„í–‰"
            git add blog-data.json
            git commit -m "ğŸš€ ë…¸ì…˜ ë¸”ë¡œê·¸ ìë™ ë™ê¸°í™” $(date '+%Y-%m-%d %H:%M:%S')"
            
            echo "=== Push ì‹œë„ ==="
            git push
            echo "âœ… ë¸”ë¡œê·¸ ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ!"
          else
            echo "ğŸ“‹ ë³€ê²½ì‚¬í•­ ì—†ìŒ - ë™ê¸°í™” ë¶ˆí•„ìš”"
          fi
      
      # 8. ê²°ê³¼ ìš”ì•½
      - name: ğŸ“Š ë™ê¸°í™” ê²°ê³¼ ìš”ì•½
        run: |
          echo "ğŸ‰ ë…¸ì…˜ ë¸”ë¡œê·¸ ë™ê¸°í™” ì™„ë£Œ!"
          echo "ğŸ“… ì‹¤í–‰ ì‹œê°„: $(date)"
          echo "ğŸ”— GitHub Pages: https://half-nomad.github.io/half-nomad-bio/"
          echo "ğŸ“ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë‚´ìš©:"
          ls -la
