name: ğŸš€ ë…¸ì…˜ ë¸”ë¡œê·¸ ë™ê¸°í™”

# íŠ¸ë¦¬ê±° ì¡°ê±´
on:
  # ìˆ˜ë™ ì‹¤í–‰ (ë…¸ì…˜ ë²„íŠ¼ì—ì„œ í˜¸ì¶œ)
  workflow_dispatch:
    inputs:
      trigger_source:
        description: 'íŠ¸ë¦¬ê±° ì†ŒìŠ¤'
        required: false
        default: 'notion-button'
  
  # Repository Dispatch (ì™¸ë¶€ API í˜¸ì¶œìš©)
  repository_dispatch:
    types: [notion-sync]

# í™˜ê²½ ë³€ìˆ˜
env:
  NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
  NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}

jobs:
  sync-notion-blog:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # 2. Node.js ì„¤ì •
      - name: ğŸŸ¢ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      # 3. ë…¸ì…˜ í´ë¼ì´ì–¸íŠ¸ ì„¤ì¹˜
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          npm init -y
          npm install @notionhq/client
      
      # 4. ë…¸ì…˜ ë°ì´í„° ë™ê¸°í™” ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: ğŸ”„ ë…¸ì…˜ ë¸”ë¡œê·¸ ë™ê¸°í™”
        run: |
          cat > sync-notion.js << 'EOF'
          const { Client } = require('@notionhq/client');
          const fs = require('fs');

          async function syncNotionBlog() {
            try {
              console.log('ğŸš€ ë…¸ì…˜ ë¸”ë¡œê·¸ ë™ê¸°í™” ì‹œì‘...');
              
              // ë…¸ì…˜ í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
              const notion = new Client({ 
                auth: process.env.NOTION_TOKEN 
              });
              
              const databaseId = process.env.NOTION_DATABASE_ID;
              
              // ë°œí–‰ëœ í¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
              const response = await notion.databases.query({
                database_id: databaseId,
                filter: {
                  property: 'Status',
                  select: { equals: 'Published' }
                },
                sorts: [{
                  property: 'Published Date',
                  direction: 'descending'
                }]
              });
              
              console.log(`ğŸ“Š ${response.results.length}ê°œì˜ ë°œí–‰ëœ í¬ìŠ¤íŠ¸ ë°œê²¬`);
              
              // í¬ìŠ¤íŠ¸ ë°ì´í„° ë³€í™˜
              const posts = [];
              for (const page of response.results) {
                const postData = await transformNotionPage(notion, page);
                posts.push(postData);
              }
              
              // blog-data.json ìƒì„±
              const blogData = {
                posts: posts,
                lastUpdated: new Date().toISOString(),
                version: "1.0.0",
                source: "github-actions"
              };
              
              // íŒŒì¼ ì €ì¥
              fs.writeFileSync('blog-data.json', JSON.stringify(blogData, null, 2));
              
              console.log(`âœ… blog-data.json ì—…ë°ì´íŠ¸ ì™„ë£Œ! (${posts.length}ê°œ í¬ìŠ¤íŠ¸)`);
              
            } catch (error) {
              console.error('âŒ ë™ê¸°í™” ì˜¤ë¥˜:', error);
              process.exit(1);
            }
          }

          async function transformNotionPage(notion, page) {
            const properties = page.properties;
            
            // ê¸°ë³¸ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
            const title = properties.Title?.title?.[0]?.plain_text || 'Untitled';
            const excerpt = properties.Excerpt?.rich_text?.[0]?.plain_text || '';
            const categoryData = properties.Category?.select;
            const category = categoryData?.name?.toLowerCase().replace(/\\s+/g, '-') || 'general';
            const categoryName = categoryData?.name || 'General';
            const publishedDate = properties['Published Date']?.date?.start || new Date().toISOString().split('T')[0];
            const readTime = `\${properties['Read Time']?.number || 5}ë¶„`;
            const thumbnail = properties.Thumbnail?.rich_text?.[0]?.plain_text || 'ğŸ“';

            // í˜ì´ì§€ ì½˜í…ì¸  ê°€ì ¸ì˜¤ê¸°
            let content = '';
            try {
              const blocks = await notion.blocks.children.list({
                block_id: page.id,
                page_size: 100
              });
              
              content = transformBlocksToHTML(blocks.results);
            } catch (error) {
              console.warn(`âš ï¸ í˜ì´ì§€ \${page.id} ì½˜í…ì¸  ë¡œë“œ ì‹¤íŒ¨:`, error.message);
              content = '<p>ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }

            return {
              id: page.id.replace(/-/g, ''),
              notionId: page.id,
              title: title,
              excerpt: excerpt,
              category: category,
              categoryName: categoryName,
              date: publishedDate,
              readTime: readTime,
              thumbnail: thumbnail,
              content: content
            };
          }

          function transformBlocksToHTML(blocks) {
            let html = '';
            
            for (const block of blocks) {
              html += transformBlockToHTML(block);
            }
            
            return html.trim();
          }

          function transformBlockToHTML(block) {
            const type = block.type;
            
            switch (type) {
              case 'paragraph':
                const text = extractRichText(block.paragraph.rich_text);
                return text ? `<p>\${text}</p>\\n` : '';
                
              case 'heading_1':
                const h1Text = extractRichText(block.heading_1.rich_text);
                return `<h2>\${h1Text}</h2>\\n`;
                
              case 'heading_2':
                const h2Text = extractRichText(block.heading_2.rich_text);
                return `<h3>\${h2Text}</h3>\\n`;
                
              case 'heading_3':
                const h3Text = extractRichText(block.heading_3.rich_text);
                return `<h4>\${h3Text}</h4>\\n`;
                
              case 'bulleted_list_item':
                const liText = extractRichText(block.bulleted_list_item.rich_text);
                return `<li>\${liText}</li>\\n`;
                
              case 'numbered_list_item':
                const numText = extractRichText(block.numbered_list_item.rich_text);
                return `<li>\${numText}</li>\\n`;
                
              case 'quote':
                const quoteText = extractRichText(block.quote.rich_text);
                return `<blockquote>\${quoteText}</blockquote>\\n`;
                
              case 'code':
                const codeText = extractRichText(block.code.rich_text);
                const language = block.code.language || '';
                return `<pre><code class="\${language}">\${escapeHtml(codeText)}</code></pre>\\n`;
                
              case 'divider':
                return '<hr>\\n';
                
              default:
                return '';
            }
          }

          function extractRichText(richTextArray) {
            if (!richTextArray || !Array.isArray(richTextArray)) return '';
            
            return richTextArray.map(textObj => {
              let text = textObj.plain_text || '';
              
              // HTML ì´ìŠ¤ì¼€ì´í”„
              text = escapeHtml(text);
              
              // í¬ë§·íŒ… ì ìš©
              if (textObj.annotations) {
                const { bold, italic, strikethrough, underline, code } = textObj.annotations;
                
                if (code) text = `<code>\${text}</code>`;
                if (bold) text = `<strong>\${text}</strong>`;
                if (italic) text = `<em>\${text}</em>`;
                if (strikethrough) text = `<del>\${text}</del>`;
                if (underline) text = `<u>\${text}</u>`;
              }
              
              // ë§í¬ ì²˜ë¦¬
              if (textObj.href) {
                text = `<a href="\${textObj.href}" target="_blank" rel="noopener">\${text}</a>`;
              }
              
              return text;
            }).join('');
          }

          function escapeHtml(text) {
            const map = {
              '&': '&amp;',
              '<': '&lt;',
              '>': '&gt;',
              '"': '&quot;',
              "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
          }

          // ì‹¤í–‰
          syncNotionBlog();
          EOF
          
          node sync-notion.js
      
      # 5. ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
      - name: ğŸ“¤ ë³€ê²½ì‚¬í•­ ì»¤ë°‹
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if [ -n "$(git status --porcelain)" ]; then
            git add blog-data.json
            git commit -m "ğŸš€ ë…¸ì…˜ ë¸”ë¡œê·¸ ìë™ ë™ê¸°í™” $(date '+%Y-%m-%d %H:%M:%S')"
            git push
            echo "âœ… ë¸”ë¡œê·¸ ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ!"
          else
            echo "ğŸ“‹ ë³€ê²½ì‚¬í•­ ì—†ìŒ - ë™ê¸°í™” ë¶ˆí•„ìš”"
          fi
      
      # 6. ê²°ê³¼ ìš”ì•½
      - name: ğŸ“Š ë™ê¸°í™” ê²°ê³¼
        run: |
          echo "ğŸ‰ ë…¸ì…˜ ë¸”ë¡œê·¸ ë™ê¸°í™” ì™„ë£Œ!"
          echo "ğŸ“… ì‹¤í–‰ ì‹œê°„: $(date)"
          echo "ğŸ”— GitHub Pages: https://half-nomad.github.io/half-nomad-bio/"
